{% extends 'layout-master.html' %}
{% block title %}Profile - Data Learning System{% endblock %}
  {% block content %}
    <div class="pagetitle">
      <h1>Profile</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/index">Home</a></li>
          <li class="breadcrumb-item">Users</li>
          <li class="breadcrumb-item active">Profile</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section profile">
      <div class="row">
        <div class="col-xl-4">

          <div class="card">
            <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">

              <img src="{{ url_for('static', filename='img/' + (session['username'] + '.png') if session.get('photo') == 1 else 'img/profile-img.jpg') }}" alt="Profile" class="rounded-circle">
              {% if session['username'] %}
              <h2>{{ session['username'] }}</h2>
              {% else %}
              {% endif %}
              {% if session['role'] == 1 %}
              <h3>Employee</h3>
              {% elif session['role'] ==2 %}
              <h3>Administration</h3>
              {% else %}
              {% endif %}
              <div class="social-links mt-2">
                <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
              </div>
            </div>
          </div>

        </div>

        <div class="col-xl-8">

          <div class="card">
            <div class="card-body pt-3">
              <!-- Bordered Tabs -->
              <ul class="nav nav-tabs nav-tabs-bordered">

                <li class="nav-item">
                  <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">Overview</button>
                </li>

                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Edit Profile</button>
                </li>

                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-settings">Settings</button>
                </li>

                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-change-password">Change Password</button>
                </li>

              </ul>
              <div class="tab-content pt-2">

                <div class="tab-pane fade show active profile-overview" id="profile-overview">
                  <h5 class="card-title">About</h5>
                  <p class="small fst-italic">Sunt est soluta temporibus accusantium neque nam maiores cumque temporibus. Tempora libero non est unde veniam est qui dolor. Ut sunt iure rerum quae quisquam autem eveniet perspiciatis odit. Fuga sequi sed ea saepe at unde.</p>

                  <h5 class="card-title">Profile Details</h5>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label ">Full Name</div>
                    <div class="col-lg-9 col-md-8">{{ session['name'] }} {{ session['last_name'] }}</div>
                  </div>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label">Company</div>
                    <div class="col-lg-9 col-md-8">Lueilwitz, Wisoky and Leuschke</div>
                  </div>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label">Job</div>
                    {% if session['role'] == 1 %}
                    <div class="col-lg-9 col-md-8">Employee</div>
                    {% elif session['role'] == 2 %}
                    <div class="col-lg-9 col-md-8">Administration</div>
                    {% else %}
                    {% endif %}
                  </div>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label">Country</div>
                    <div class="col-lg-9 col-md-8">USA</div>
                  </div>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label">Address</div>
                    <div class="col-lg-9 col-md-8">A108 Adam Street, New York, NY 535022</div>
                  </div>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label">Phone</div>
                    <div class="col-lg-9 col-md-8">(436) 486-3538 x29071</div>
                  </div>

                  <div class="row">
                    <div class="col-lg-3 col-md-4 label">Email</div>
                    <div class="col-lg-9 col-md-8">{{ session['email'] }}</div>
                  </div>

                </div>

                <div class="tab-pane fade profile-edit pt-3" id="profile-edit">

                  <!-- Profile Edit Form -->
                  <form id="profileEditForm" enctype="multipart/form-data" novalidate onsubmit="return validateProfileForm();">
                    <div class="row mb-3">
                      <label for="profileImage" class="col-md-4 col-lg-3 col-form-label">Imagen de Perfil</label>
                      <div class="col-md-8 col-lg-9">
                        <img src="{{ url_for('static', filename='img/' + (session['username'] + '.png') if session.get('photo') == 1 else 'img/profile-img.jpg') }}" alt="Profile" class="rounded-circle">
                        <input type="file" class="form-control" name="photo" id="profileImage" onchange="previewImage();">
                        <div class="pt-2">
                          <button class="btn btn-primary btn-sm" type="button" title="Subir nueva imagen de perfil" onclick="document.getElementById('profileImage').click();"><i class="bi bi-upload"></i> Subir</button>
                          <button class="btn btn-danger btn-sm" type="button" title="Eliminar mi imagen de perfil" onclick="removeImage();"><i class="bi bi-trash"></i> Eliminar</button>
                        </div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="Name" class="col-md-4 col-lg-3 col-form-label">Nombre</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="name" type="text" class="form-control" id="Name" value="{{ session['name'] }}" required>
                        <div class="invalid-feedback">Por favor, ingresa tu nombre.</div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="LastName" class="col-md-4 col-lg-3 col-form-label">Apellido</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="lastName" type="text" class="form-control" id="LastName" value="{{ session['last_name'] }}" required>
                        <div class="invalid-feedback">Por favor, ingresa tu apellido.</div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="Username" class="col-md-4 col-lg-3 col-form-label">Nombre de Usuario</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="username" type="text" class="form-control" id="Username" value="{{ session['username'] }}" required minlength="5" pattern="^[a-zA-Z0-9_]+$" title="El nombre de usuario debe tener al menos 5 caracteres y contener solo letras, números y guiones bajos.">
                        <div class="invalid-feedback">Por favor, ingresa tu nombre de usuario (¡al menos 5 caracteres).</div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="Email" class="col-md-4 col-lg-3 col-form-label">Correo Electrónico</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="email" type="email" class="form-control" id="Email" value="{{ session['email'] }}" required pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="Por favor, ingresa un correo electrónico válido.">
                        <div class="invalid-feedback">Por favor, ingresa un correo electrónico válido.</div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="PhoneNumber" class="col-md-4 col-lg-3 col-form-label">Número de Teléfono</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="phoneNumber" type="text" class="form-control" id="PhoneNumber" value="{{ session['phone_number'] }}" required pattern="^\d{10}$" title="El número de teléfono debe tener 10 dígitos.">
                        <div class="invalid-feedback">Por favor, ingresa un número de teléfono válido (10 dígitos).</div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="Address" class="col-md-4 col-lg-3 col-form-label">Dirección</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="address" type="text" class="form-control" id="Address" value="{{ session['address'] }}">
                      </div>
                    </div>

                    <div class="text-center">
                      <button type="button" class="btn btn-primary" onclick="submitProfileForm();">Guardar Cambios</button>
                    </div>
                  </form><!-- End Profile Edit Form -->

                </div>

                <div class="tab-pane fade pt-3" id="profile-settings">

                  <!-- Settings Form -->
                  <form>

                    <div class="row mb-3">
                      <label for="fullName" class="col-md-4 col-lg-3 col-form-label">Email Notifications</label>
                      <div class="col-md-8 col-lg-9">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="changesMade" checked>
                          <label class="form-check-label" for="changesMade">
                            Changes made to your account
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="newProducts" checked>
                          <label class="form-check-label" for="newProducts">
                            Information on new products and services
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="proOffers">
                          <label class="form-check-label" for="proOffers">
                            Marketing and promo offers
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="securityNotify" checked disabled>
                          <label class="form-check-label" for="securityNotify">
                            Security alerts
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="text-center">
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form><!-- End settings Form -->

                </div>

                <div class="tab-pane fade pt-3" id="profile-change-password">
                  <!-- Change Password Form -->
                  <form method="post" action="/change_password">

                    <div class="row mb-3">
                      <label for="currentPassword" class="col-md-4 col-lg-3 col-form-label">Username</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="username" type="text" class="form-control" id="currentPassword" value="{{ session['username'] }}" readonly>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="newPassword" class="col-md-4 col-lg-3 col-form-label">New Password</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="newpassword" type="password" class="form-control" id="newPassword" required>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <label for="renewPassword" class="col-md-4 col-lg-3 col-form-label">Re-enter New Password</label>
                      <div class="col-md-8 col-lg-9">
                        <input name="renewpassword" type="password" class="form-control" id="renewPassword" required>
                      </div>
                    </div>

                    <div class="text-center mb-3">
                      <button type="submit" class="btn btn-outline-primary">Change Password</button>
                    </div>
                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-light text-white bg-info alert-dismissible fade show" role="alert">
                          {{message}}
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                        {% endif %}
                    {% endwith %}
                  </form><!-- End Change Password Form -->

                </div>

              </div><!-- End Bordered Tabs -->

            </div>
          </div>

        </div>
      </div>
    </section>

    <script>
    function submitProfileForm() {
        const formData = new FormData(document.getElementById('profileEditForm'));
        const userId = "{{ session['user_id'] }}"; // Obtener el ID del usuario de la sesión

        fetch(`{{ url_for('auth.user_profile', id='') }}${userId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message); // Mostrar mensaje de éxito
                // Aquí puedes redirigir o actualizar la interfaz según sea necesario
            } else if (data.error) {
                alert(data.error); // Mostrar mensaje de error
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al enviar el formulario. Por favor, inténtelo de nuevo más tarde.');
        });
    }

    function previewImage() {
        var file = document.getElementById("profileImage").files[0];
        var reader = new FileReader();
        reader.onloadend = function() {
            document.querySelector('img.rounded-circle').src = reader.result;
        }
        if (file) {
            reader.readAsDataURL(file);
        } else {
            document.querySelector('img.rounded-circle').src = "{{ url_for('static', filename='img/profile-img.jpg') }}";
        }
    }

    function removeImage() {
        document.getElementById("profileImagePreview").src = "{{ url_for('static', filename='img/profile-img.jpg') }}";
        document.getElementById("profileImage").value = "";
    }

    function validateProfileForm() {
        const form = document.getElementById('profileEditForm');
        const alertMessage = document.getElementById('alertMessage');
        const alertText = document.getElementById('alertText');

        // Limpiar mensajes de alerta
        alertMessage.classList.add('d-none');
        alertText.innerText = '';

        // Validar el formulario
        if (!form.checkValidity()) {
            // Si el formulario no es válido, mostrar los mensajes de error
            Array.from(form.elements).forEach(element => {
                if (element.tagName === 'INPUT') {
                    if (!element.checkValidity()) {
                        element.classList.add('is-invalid');
                    } else {
                        element.classList.remove('is-invalid');
                    }
                }
            });

            // Mostrar mensaje de alerta si hay un error
            alertText.innerText = 'Por favor, completa todos los campos requeridos correctamente.';
            alertMessage.classList.remove('d-none');
            return false; // Evitar el envío del formulario
        }

        // Si todo está bien, permitir el envío del formulario
        return true;
    }
    </script>
  {% endblock %}